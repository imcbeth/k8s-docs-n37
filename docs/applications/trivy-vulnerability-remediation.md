# Trivy Vulnerability Remediation Guide

## Production Status

**Last Updated:** 2026-01-06

**Trivy Operator Status:** ‚úÖ OPERATIONAL (14h uptime)

**Current Alerts:**

- ‚úÖ CriticalVulnerabilitiesDetected: Firing (expected during initial remediation phase)
- ‚úÖ HighVulnerabilityCount: Firing for 6 images
- ‚úÖ ExposedSecretsDetected: **Not firing** (no secrets exposed)
- ‚úÖ Alert routing to email confirmed working

**Recent Activity:**

- 77 vulnerability reports generated
- 43 CRITICAL, 606 HIGH, 1,499 MEDIUM vulnerabilities identified
- Automated daily rescans active
- Email notifications received and validated

## Overview

This guide provides procedures for responding to and remediating vulnerabilities detected by Trivy Operator in the Raspberry Pi 5 Kubernetes homelab cluster.

## Monitoring and Alerting

### Grafana Dashboard

Access the Trivy Security Dashboard at: `https://grafana.k8s.n37.ca`

**Dashboard Panels:**

- **Total Vulnerabilities**: Critical, High, and Medium severity counts
- **Images Scanned**: Total number of container images monitored
- **Vulnerabilities by Image**: Sortable table with severity breakdown
- **Severity Distribution**: Pie chart showing vulnerability composition
- **Namespace Breakdown**: Critical+High vulnerabilities by namespace

### Active Alerts

PrometheusRule alerts configured in `manifests/base/trivy-operator/trivy-alerts.yaml`:

| Alert Name | Severity | Threshold | Purpose |
|------------|----------|-----------|---------|
| `CriticalVulnerabilitiesDetected` | Critical | Any image with CRITICAL CVEs | Immediate notification of critical security issues |
| `HighVulnerabilityCount` | Warning | >20 HIGH vulnerabilities in single image | Warn when vulnerability count is excessive |
| `ClusterCriticalVulnerabilityThresholdExceeded` | Warning | >100 CRITICAL across cluster | Cluster-wide security posture degradation |
| `ExposedSecretsDetected` | Critical | Any exposed secrets in images | **IMMEDIATE ACTION REQUIRED** |
| `HighRiskRBACPermissions` | Warning | Critical RBAC issues | Overly permissive cluster roles |
| `CISKubernetesBenchmarkFailures` | Info | CIS compliance failures | Compliance monitoring |
| `NSAKubernetesHardeningFailures` | Info | NSA hardening failures | Security hardening gaps |

## Vulnerability Response Workflow

### 1. Alert Triage (within 1 hour)

When receiving a vulnerability alert:

```bash
# View all vulnerability reports
kubectl get vulnerabilityreports -A

# Get detailed report for specific workload
kubectl get vulnerabilityreport -n <namespace> <report-name> -o yaml

# Filter for CRITICAL vulnerabilities only
kubectl get vulnerabilityreports -A -o json | \
  jq -r '.items[] | select(.report.summary.criticalCount > 0) |
  "\(.metadata.namespace)/\(.metadata.labels."trivy-operator.resource.name"): \(.report.summary.criticalCount) CRITICAL"'
```

### 2. Vulnerability Assessment

**For each CRITICAL vulnerability:**

1. **Identify the CVE:**

   ```bash
   kubectl get vulnerabilityreport -n <namespace> <report> -o json | \
     jq -r '.report.vulnerabilities[] | select(.severity == "CRITICAL") |
     "\(.vulnerabilityID): \(.title)"'
   ```

2. **Check exploitability:**
   - Review CVE details at [nvd.nist.gov](https://nvd.nist.gov)
   - Check if vulnerability is remotely exploitable
   - Determine if affected component is exposed to network

3. **Assess impact:**
   - Is the vulnerable package actually used by the application?
   - What's the blast radius if exploited?
   - Are there compensating controls (network policies, RBAC)?

### 3. Remediation Strategies

#### Strategy A: Update Container Image (Preferred)

**Best for:** Vendor-maintained images (ArgoCD, Grafana, Prometheus)

```bash
# Check current image version
kubectl get deployment -n <namespace> <name> -o jsonpath='{.spec.template.spec.containers[0].image}'

# Check for newer image versions
# For Helm charts:
helm search repo <chart-name> --versions | head -10

# Update Helm chart version in ArgoCD Application
vim manifests/applications/<app>.yaml
# Update targetRevision to latest stable version

# Create PR and deploy
git add manifests/applications/<app>.yaml
git commit -m "fix: Update <app> to address CVE-YYYY-XXXXX"
git push
gh pr create
```

#### Strategy B: Rebuild Custom Images

**Best for:** Custom applications and images you control

```bash
# Update base image in Dockerfile
FROM debian:12-slim  # Update to latest stable base image

# Rebuild and push
docker build -t <registry>/<image>:<new-tag> .
docker push <registry>/<image>:<new-tag>

# Update Kubernetes manifest
kubectl set image deployment/<name> <container>=<registry>/<image>:<new-tag> -n <namespace>
```

#### Strategy C: Accept Risk (Temporary)

**Only when:**

- No patch available from vendor
- Vulnerability not exploitable in your environment
- Critical business application cannot be updated immediately

**Document in issue tracker:**

```markdown
## Accepted Risk: CVE-YYYY-XXXXX in <component>

**Severity:** CRITICAL
**Affected:** <namespace>/<workload>
**Reason:** [No patch available / Business critical / Isolated environment]
**Compensating Controls:**
- Network policy restricts ingress to pod
- RBAC limits pod permissions
- WAF/ingress filtering applied
**Remediation Plan:** Upgrade to <version> when available (ETA: <date>)
**Review Date:** <date>
```

### 4. Post-Remediation Verification

After applying fixes:

```bash
# Force Trivy rescan (Trivy rescans every 24h by default)
kubectl delete vulnerabilityreport -n <namespace> <report>
# Trivy will automatically regenerate the report

# Wait 2-3 minutes for scan to complete, then verify
kubectl get vulnerabilityreport -n <namespace> -o json | \
  jq '.items[] | {name: .metadata.name, critical: .report.summary.criticalCount, high: .report.summary.highCount}'

# Check Grafana dashboard for updated metrics
```

## Common Vulnerability Scenarios

### Scenario 1: Base OS Package Vulnerabilities (Debian/Alpine)

**Example:** CVE-2024-37371 (Kerberos vulnerability in Debian base image)

**Root Cause:** Outdated base image layer

**Remediation:**

```bash
# Update base image to latest patch version
FROM debian:12.8-slim  # Instead of debian:11-slim

# Or switch to distroless for minimal attack surface
FROM gcr.io/distroless/base-debian12
```

### Scenario 2: Go/Python Library Vulnerabilities

**Example:** CVE-2024-45337 (golang.org/x/crypto SSH vulnerability)

**Root Cause:** Outdated Go module dependencies

**Remediation:**

```bash
# Update Go dependencies
go get -u golang.org/x/crypto@latest
go mod tidy

# Rebuild application
docker build -t <image>:<new-tag> .
```

### Scenario 3: Exposed Secrets in Container Images

**CRITICAL - IMMEDIATE ACTION REQUIRED**

**Example:** AWS credentials, API keys, passwords in image layers

**Remediation:**

1. **Immediately rotate exposed credentials**
2. **Remove secret from image:**

   ```bash
   # Use Kubernetes Secrets instead
   kubectl create secret generic <name> --from-literal=api-key=<value>

   # Mount as environment variable
   env:
   - name: API_KEY
     valueFrom:
       secretKeyRef:
         name: <name>
         key: api-key
   ```

3. **Rebuild image without secrets**
4. **Review git history** - ensure secrets never committed to source

### Scenario 4: Third-Party Helm Chart Vulnerabilities

**Example:** Synology CSI driver with 5 CRITICAL vulnerabilities

**Remediation:**

```bash
# Check for chart updates
helm search repo synology-csi --versions

# If no update available, check upstream GitHub
# File issue: https://github.com/SynologyOpenSource/synology-csi/issues

# Temporary mitigation:
# - Apply network policies to restrict CSI pod access
# - Monitor for suspicious activity in CSI pods
```

## Vulnerability Remediation Priorities

### Priority 1: CRITICAL - Act within 24 hours

- Exposed secrets in images
- Remotely exploitable RCE vulnerabilities
- Privilege escalation in cluster-facing components (API server, kubelet)

### Priority 2: HIGH - Act within 1 week

- High severity vulnerabilities in internet-facing services
- Container escape vulnerabilities
- Authentication bypass in exposed services

### Priority 3: MEDIUM - Act within 1 month

- Medium severity vulnerabilities with no known exploits
- Vulnerabilities in internal-only services
- Denial of Service vulnerabilities

### Priority 4: LOW - Best effort

- Low severity vulnerabilities
- Vulnerabilities in unused code paths
- Informational findings

## Compliance and Reporting

### Weekly Vulnerability Review

```bash
# Generate weekly vulnerability summary
kubectl get vulnerabilityreports -A -o json | \
  jq -r '["NAMESPACE","RESOURCE","CRITICAL","HIGH","MEDIUM"],
  (.items[] | [
    .metadata.namespace,
    .metadata.labels."trivy-operator.resource.name",
    (.report.summary.criticalCount // 0),
    (.report.summary.highCount // 0),
    (.report.summary.mediumCount // 0)
  ]) | @tsv' | column -t

# Track remediation progress
# Compare against previous week's counts
```

### Monthly Compliance Reports

```bash
# CIS Kubernetes Benchmark status
kubectl get clustercompliancereport k8s-cis-1.23 -o json | \
  jq '{
    title: .spec.title,
    passCount: (.status.summary.passCount // 0),
    failCount: (.status.summary.failCount // 0)
  }'

# NSA Kubernetes Hardening Guidance
kubectl get clustercompliancereport k8s-nsa-1.0 -o json | \
  jq '{
    title: .spec.title,
    passCount: (.status.summary.passCount // 0),
    failCount: (.status.summary.failCount // 0)
  }'
```

## Preventive Measures

### 1. Image Selection Best Practices

- **Prefer official images:** Use official vendor images (e.g., `prom/prometheus`, `grafana/grafana`)
- **Use minimal base images:** Prefer `alpine` or `distroless` over full Debian/Ubuntu
- **Pin specific versions:** Avoid `:latest` tag, use semantic versioning
- **Verify image signatures:** Use Cosign for image signature verification

### 2. Continuous Scanning

Trivy automatically scans:

- **On deployment:** New images scanned within minutes
- **Daily rescans:** All images rescanned every 24 hours
- **Compliance checks:** Daily CIS/NSA compliance assessment

### 3. Automated Updates

```yaml
# Configure Renovate Bot for automated dependency updates
# .github/renovate.json
{
  "extends": ["config:base"],
  "kubernetes": {
    "fileMatch": ["manifests/.+\\.yaml$"]
  },
  "helm-values": {
    "fileMatch": ["manifests/base/.+/values\\.yaml$"]
  }
}
```

## Troubleshooting

### Trivy Scan Failures

```bash
# Check Trivy Operator logs
kubectl logs -n trivy-system deployment/trivy-operator --tail=100

# Check Trivy server logs
kubectl logs -n trivy-system statefulset/trivy-server --tail=100

# Manually trigger scan
kubectl delete vulnerabilityreport -n <namespace> <report>
```

### False Positives

If Trivy reports a vulnerability that doesn't apply:

1. **Verify the finding:**

   ```bash
   kubectl get vulnerabilityreport <name> -o json | \
     jq '.report.vulnerabilities[] | select(.vulnerabilityID == "CVE-YYYY-XXXXX")'
   ```

2. **Check if package is actually used:**

   ```bash
   # Exec into container and verify
   kubectl exec -n <namespace> <pod> -- dpkg -l | grep <package>
   ```

3. **Create exception if confirmed false positive:**

   ```yaml
   # Add to trivy-operator values.yaml
   trivyOperator:
     ignoreUnfixed: true
     ignoreVulnerabilities:
       - CVE-YYYY-XXXXX  # Document reason
   ```

## Resources

- **Trivy Documentation:** [aquasecurity.github.io/trivy/](https://aquasecurity.github.io/trivy/)
- **CVE Database:** [nvd.nist.gov/](https://nvd.nist.gov/)
- **Kubernetes Security Best Practices:** [kubernetes.io/docs/concepts/security/](https://kubernetes.io/docs/concepts/security/)
- **CIS Kubernetes Benchmark:** [www.cisecurity.org/benchmark/kubernetes](https://www.cisecurity.org/benchmark/kubernetes)
- **NSA/CISA Hardening Guide:** [media.defense.gov/2022/Aug/29/2003066362/-1/-1/0/CTR_KUBERNETES_HARDENING_GUIDANCE_1.2_20220829.PDF](https://media.defense.gov/2022/Aug/29/2003066362/-1/-1/0/CTR_KUBERNETES_HARDENING_GUIDANCE_1.2_20220829.PDF)

## Current Cluster Status

**Production Data** (2026-01-06 morning, 14h post-deployment):

| Severity | Count | Change from Initial | Top Affected Components |
|----------|-------|---------------------|-------------------------|
| CRITICAL | 43 | ‚¨áÔ∏è -10 (improved) | Promtail (7), Synology CSI (3-5 each) |
| HIGH | 606 | ‚¨áÔ∏è -148 (improved) | Synology CSI (48-57 each), Promtail (34) |
| MEDIUM | 1,499 | ‚û°Ô∏è +4 (stable) | Cluster-wide |
| **TOTAL** | **2,148** | **‚¨áÔ∏è -154** | **25% of images with CRITICAL** |

**Vulnerability Trend:** ‚¨áÔ∏è **IMPROVING**

The reduction in vulnerability counts is attributed to:

1. Trivy's vulnerability database updating overnight with vendor fixes
2. CVEs being marked as fixed in newer package versions
3. More accurate scanning with updated Trivy signatures

**Key CVEs to address:**

- CVE-2024-37371: Kerberos GSS (affects multiple base images) - **High Priority**
- CVE-2024-41110: Docker/Moby authorization bypass - **High Priority**
- CVE-2024-45337: Golang SSH vulnerability - **Medium Priority**
- CVE-2024-24790: Golang net/netip issue - **Medium Priority**

**Remediation Progress Tracking:**

| Component | CRITICAL | HIGH | Remediation Status | Target Date |
|-----------|----------|------|--------------------|-------------|
| Promtail | 7 | 34 | üî¥ Not started | 2026-01-10 |
| Synology CSI | 3-5 | 48-57 | üî¥ Not started | 2026-01-13 |
| ArgoCD Redis | 3 | 34 | üî¥ Not started | 2026-01-15 |
| Other components | ~30 | ~450 | üü° Triaged | 2026-01-31 |

**Next Steps:**

1. ‚úÖ Trivy Operator deployed and operational
2. ‚úÖ Monitoring and alerting confirmed working
3. üî≤ Review and update Promtail to latest version (Priority 1)
4. üî≤ Check for Synology CSI driver updates (Priority 1)
5. üî≤ Update base images cluster-wide (Priority 2)
6. üî≤ Implement automated update pipeline (Renovate Bot)
