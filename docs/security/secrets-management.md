---
title: "Secrets Management"
description: "GitOps-compatible secrets management with Sealed Secrets"
---

# Secrets Management

This homelab uses **Sealed Secrets** for GitOps-compatible secrets management, allowing encrypted secrets to be safely stored in Git and automatically decrypted by the cluster.

## Overview

- **Solution:** Bitnami Sealed Secrets
- **Namespace:** `kube-system` (controller)
- **Deployment:** Managed by ArgoCD
- **Sync Wave:** `-25` (deploys early, before applications needing secrets)

## Why Sealed Secrets?

### The Problem with Kubernetes Secrets

Standard Kubernetes Secrets are base64-encoded (not encrypted) and cannot be safely committed to Git repositories. This creates challenges for GitOps workflows where all configuration should be version-controlled.

### Previous Approach: git-crypt

Previously, secrets were encrypted with git-crypt in the repository. However:

- ArgoCD cannot decrypt git-crypt files
- Required manual `kubectl apply` before ArgoCD sync
- Not truly GitOps-compliant

### Sealed Secrets Solution

Sealed Secrets solves this by:

- **Encrypting secrets client-side** using the cluster's public key
- **Storing encrypted SealedSecret CRDs in Git** (safe to commit)
- **Decrypting at runtime** via the Sealed Secrets controller
- **Full GitOps compatibility** - ArgoCD can sync SealedSecrets directly

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                    Secrets Management                           │
├─────────────────────────────────────────────────────────────────┤
│ Sealed Secrets Controller (kube-system)                         │
│   └─ Decrypts SealedSecret CRDs at runtime                     │
│                                                                 │
│ SealedSecrets in Git (8 total):                                │
│   ├─ manifests/base/unipoller/unipoller-sealed.yaml            │
│   ├─ manifests/base/external-dns/cloudflare-sealed.yaml        │
│   ├─ manifests/base/external-dns/unifi-sealed.yaml             │
│   ├─ manifests/base/kube-prometheus-stack/alertmanager-smtp-sealed.yaml │
│   ├─ manifests/base/kube-prometheus-stack/snmp-exporter-sealed.yaml    │
│   ├─ manifests/base/cert-manager/cloudflare-sealed.yaml        │
│   ├─ manifests/base/synology-csi/client-info-sealed.yaml       │
│   └─ manifests/base/pihole/pihole-web-sealed.yaml              │
│                                                                 │
│ Bootstrap Secret (manual apply required):                      │
│   └─ secrets/argocd-git-access.yaml                            │
│                                                                 │
│ Helm-Managed Secrets (auto-generated):                         │
│   └─ kube-prometheus-stack-grafana                             │
└─────────────────────────────────────────────────────────────────┘
```

## Managed Secrets

| Secret Name | Namespace | Application | Purpose |
|-------------|-----------|-------------|---------|
| `unipoller-secret` | unipoller | UniFi Poller | UniFi controller API key |
| `cloudflare-api-token` | external-dns | External DNS | Cloudflare DNS API token |
| `unifi-credentials` | external-dns | External DNS | UniFi webhook credentials |
| `alertmanager-smtp-credentials` | default | Alertmanager | Email notification SMTP credentials |
| `snmp-exporter-credentials` | default | SNMP Exporter | Synology NAS SNMPv3 credentials |
| `cloudflare-api-token-secret` | cert-manager | cert-manager | DNS01 challenge API token |
| `client-info-secret` | synology-csi | Synology CSI | NAS iSCSI authentication |
| `pihole-web-password` | pihole | Pi-hole | Web interface password |

## Secrets NOT Managed by Sealed Secrets

| Secret | Reason | How to Apply |
|--------|--------|--------------|
| `my-ssh-repo-secret-homelab` | Bootstrap secret - ArgoCD needs this to read the repo | `kubectl apply -f secrets/argocd-git-access.yaml` |
| `kube-prometheus-stack-grafana` | Auto-generated by Helm chart | Managed automatically |

## Using kubeseal

### Prerequisites

Install the `kubeseal` CLI:

```bash
# macOS
brew install kubeseal

# Linux
wget https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.0/kubeseal-0.24.0-linux-amd64.tar.gz
tar -xvzf kubeseal-0.24.0-linux-amd64.tar.gz
sudo install -m 755 kubeseal /usr/local/bin/kubeseal
```

### Creating a New SealedSecret

**Step 1: Create a standard Kubernetes Secret YAML:**

```yaml
# my-secret.yaml (DO NOT commit this file)
apiVersion: v1
kind: Secret
metadata:
  name: my-secret
  namespace: my-namespace
type: Opaque
stringData:
  username: myuser
  password: mysecretpassword
```

**Step 2: Seal the secret using kubeseal:**

```bash
# Fetch the public certificate and seal the secret
kubeseal --cert <(kubectl get secret -n kube-system \
  -l sealedsecrets.bitnami.com/sealed-secrets-key=active \
  -o jsonpath='{.items[0].data.tls\.crt}' | base64 -d) \
  --format yaml < my-secret.yaml > my-sealed.yaml
```

**Step 3: Commit the SealedSecret:**

```bash
# The sealed secret is safe to commit
git add my-sealed.yaml
git commit -m "feat: Add my-secret as SealedSecret"
```

**Step 4: Delete the unencrypted secret:**

```bash
rm my-secret.yaml
```

### Updating an Existing Secret

To update a secret, create a new SealedSecret with the same name and namespace. The Sealed Secrets controller will update the underlying Secret.

```bash
# Create updated secret YAML with new values
# Seal it with kubeseal
# Commit and push - ArgoCD will sync the update
```

## Controller Deployment

### ArgoCD Application

**Location:** `manifests/applications/seal-controller.yaml`

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: sealed-secrets
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "-25"
spec:
  project: infrastructure
  sources:
    - repoURL: https://bitnami-labs.github.io/sealed-secrets
      chart: sealed-secrets
      targetRevision: 2.16.2
      helm:
        valueFiles:
          - $values/manifests/base/sealed-secrets/values.yaml
    - repoURL: git@github.com:imcbeth/homelab.git
      path: manifests/base/sealed-secrets
      targetRevision: HEAD
      ref: values
  destination:
    server: https://kubernetes.default.svc
    namespace: kube-system
```

### Resource Configuration

Optimized for Raspberry Pi cluster:

```yaml
resources:
  requests:
    cpu: 10m
    memory: 32Mi
  limits:
    cpu: 100m
    memory: 128Mi
```

**Actual usage:** ~1m CPU, ~9Mi memory

## Operations

### Verify Controller Status

```bash
# Check controller pod
kubectl get pods -n kube-system -l app.kubernetes.io/name=sealed-secrets

# View controller logs
kubectl logs -n kube-system -l app.kubernetes.io/name=sealed-secrets
```

### List All SealedSecrets

```bash
# List SealedSecrets in all namespaces
kubectl get sealedsecrets -A
```

### Verify Secret Decryption

```bash
# Check if the corresponding Secret was created
kubectl get secret my-secret -n my-namespace

# View secret details (base64 encoded)
kubectl get secret my-secret -n my-namespace -o yaml
```

### Troubleshooting Decryption

If a SealedSecret isn't being decrypted:

```bash
# Check SealedSecret status
kubectl describe sealedsecret my-sealed -n my-namespace

# Check controller logs for errors
kubectl logs -n kube-system -l app.kubernetes.io/name=sealed-secrets | grep -i error
```

**Common issues:**

- **"no key could decrypt secret"** - Secret was sealed with a different cluster's key
- **"already exists and is not managed"** - Delete existing secret first, then let SealedSecret recreate it

## Backup and Disaster Recovery

### Backing Up the Sealing Key

The sealing key pair is critical for disaster recovery. Back it up securely:

```bash
# Export the sealing key (KEEP THIS SECURE!)
kubectl get secret -n kube-system \
  -l sealedsecrets.bitnami.com/sealed-secrets-key=active \
  -o yaml > sealed-secrets-key-backup.yaml

# Store securely (encrypted, offline, or in a vault)
```

### Restoring After Cluster Rebuild

1. Install Sealed Secrets controller
2. Apply the backed-up sealing key:

   ```bash
   kubectl apply -f sealed-secrets-key-backup.yaml
   ```

3. Restart the controller to pick up the restored key
4. ArgoCD will sync all SealedSecrets automatically

### Key Rotation

To rotate the sealing key (recommended periodically):

```bash
# Generate new key pair
kubectl annotate sealedsecret -n kube-system \
  -l sealedsecrets.bitnami.com/sealed-secrets-key \
  sealedsecrets.bitnami.com/managed="true"

# Re-seal all secrets with new key
# Old secrets continue working until they're re-sealed
```

## Best Practices

### Security

1. **Never commit unencrypted secrets** - Always use kubeseal
2. **Back up sealing keys** - Store securely for disaster recovery
3. **Rotate keys periodically** - Re-seal secrets with new keys
4. **Limit secret scope** - Use namespace-specific secrets when possible

### GitOps Workflow

1. **Use output redirect** - Always use `kubeseal ... > file.yaml` instead of copy-paste
2. **Name convention** - Use `*-sealed.yaml` suffix for SealedSecret files
3. **Pre-commit exclusions** - SealedSecrets are excluded from yamllint (long encrypted lines)
4. **Test in staging** - Verify secrets work before promoting to production

### Helm-Managed Secrets

Don't use SealedSecrets for secrets managed by Helm charts:

- Grafana admin password (auto-generated)
- Other chart-created secrets

These secrets are created by Helm and would conflict with SealedSecrets.

## Migration from git-crypt

As of January 2026, all secrets were migrated from git-crypt to Sealed Secrets:

**Migrated:**

- unipoller-secret
- external-dns cloudflare and unifi credentials
- alertmanager SMTP credentials
- snmp-exporter credentials
- cert-manager cloudflare token
- synology-csi client info
- pihole web password

**Not migrated (by design):**

- ArgoCD SSH key (bootstrap dependency)
- Grafana password (Helm-managed)

## Related Documentation

- [ArgoCD Application Management](../applications/argocd.md)
- [cert-manager](../applications/cert-manager.md)
- [external-dns](../applications/external-dns.md)
- [UniFi Poller](../applications/unipoller.md)
- [Synology CSI](../storage/synology-csi.md)

## References

- [Sealed Secrets GitHub](https://github.com/bitnami-labs/sealed-secrets)
- [Sealed Secrets Documentation](https://sealed-secrets.netlify.app/)
- [kubeseal CLI Reference](https://github.com/bitnami-labs/sealed-secrets#kubeseal)

---

**Last Updated:** 2026-01-14
**Status:** Production, All secrets migrated
**Managed By:** ArgoCD (`manifests/applications/seal-controller.yaml`)
